<Project>

	<!-- Templates Properties -->
	<PropertyGroup Label="TemplatesProperties">
		<ResolveStaticWebAssetsInputsDependsOn>
			RegisterWebHostAssetsFiles;
			$(ResolveStaticWebAssetsInputsDependsOn)
		</ResolveStaticWebAssetsInputsDependsOn>
	</PropertyGroup>

	<!-- Templates Replacements Normalized Properties -->
	<PropertyGroup Label="TemplatesReplacementsNormalizedProperties">
		<ApiHostPathNormalized>$(ApiHostProjectFile.Replace('\', '/'))</ApiHostPathNormalized>
		<WebHostPathNormalized>$(WebHostProjectFile.Replace('\', '/'))</WebHostPathNormalized>
		<AspireHostPathNormalized>$(AspireHostProjectFile.Replace('\', '/'))</AspireHostPathNormalized>
		<AspireHostDirNormalized>$([System.IO.Path]::GetDirectoryName('$(AspireHostProjectFile)'))</AspireHostDirNormalized>
		<AspireHostDirNormalized>$(AspireHostDirNormalized.Replace('\', '/'))</AspireHostDirNormalized>
	</PropertyGroup>

	<!-- Templates Replacements Properties -->
	<PropertyGroup Label="TemplatesReplacementsProperties" Condition="$(IsWebApplicationHost)=='true' And $(Configuration)=='Release'">
		<IndexThemesSection>$(IndexThemesSection)&lt;link rel="stylesheet" href="styles/light.css" id="theme-light" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection>$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="styles/dark.css" id="theme-dark" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection>$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="styles/common.css" id="theme-common" disabled /&gt;</IndexThemesSection>
		<IndexDefaultScriptsSection>$(IndexDefaultScriptsSection)&lt;script src="scripts.js"&gt;&lt;/script&gt;</IndexDefaultScriptsSection>
	</PropertyGroup>

	<!-- Templates Replacements Properties -->
	<PropertyGroup Label="TemplatesReplacementsProperties" Condition="$(IsWebApplicationHost)=='true' And $(Configuration)!='Release'">
		<IndexThemesSection Condition="!Exists('$(LocalAssetsFolder)\dev\light.css')">$(IndexThemesSection)&lt;link rel="stylesheet" href="styles/light.css" id="theme-light" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection Condition="Exists('$(LocalAssetsFolder)\dev\light.css')">$(IndexThemesSection)&lt;link rel="stylesheet" href="dev/light.css" id="theme-light" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection Condition="!Exists('$(LocalAssetsFolder)\dev\dark.css')">$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="styles/dark.css" id="theme-dark" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection Condition="Exists('$(LocalAssetsFolder)\dev\dark.css')">$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="dev/dark.css" id="theme-dark" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection Condition="!Exists('$(LocalAssetsFolder)\dev\common.css')">$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="styles/common.css" id="theme-common" disabled /&gt;</IndexThemesSection>
		<IndexThemesSection Condition="Exists('$(LocalAssetsFolder)\dev\common.css')">$(IndexThemesSection)&#xD;&#xA;&#x9;&lt;link rel="stylesheet" href="dev/common.css" id="theme-common" disabled /&gt;</IndexThemesSection>
		<IndexBootScriptsSection Condition="!Exists('$(LocalAssetsFolder)\scripts\boot.js')">&lt;script&gt;&#xD;&#xA;$([System.Text.RegularExpressions.Regex]::Replace($([System.Text.RegularExpressions.Regex]::Replace($([System.IO.File]::ReadAllText('$(BaseAssetsFolder)\scripts\boot.js').Trim()), '(?m)^\s*$\n?', '')), '(?m)^', '&#x9;&#x9;'))&#xD;&#xA;&#x9;&lt;/script&gt;</IndexBootScriptsSection>
		<IndexBootScriptsSection Condition="Exists('$(LocalAssetsFolder)\scripts\boot.js')">&lt;script&gt;&#xD;&#xA;$([System.Text.RegularExpressions.Regex]::Replace($([System.Text.RegularExpressions.Regex]::Replace($([System.IO.File]::ReadAllText('$(LocalAssetsFolder)\scripts\boot.js').Trim()), '(?m)^\s*$\n?', '')), '(?m)^', '&#x9;&#x9;'))&#xD;&#xA;&#x9;&lt;/script&gt;</IndexBootScriptsSection>
		<IndexDefaultScriptsSection>$(IndexDefaultScriptsSection)&lt;script src="scripts.js"&gt;&lt;/script&gt;</IndexDefaultScriptsSection>
		<IndexDefaultScriptsSection Condition="Exists('$(LocalAssetsFolder)\dev\scripts.js')">$(IndexDefaultScriptsSection)&#xD;&#xA;&#x9;&lt;script src="dev/scripts.js"&gt;&lt;/script&gt;</IndexDefaultScriptsSection>
	</PropertyGroup>

	<!-- Templates Replacements Properties -->
	<PropertyGroup Label="TemplatesReplacementsProperties">
		<TemplatesReplacements>
			{{APPNAME}},$(AppName);
			{{NAMESPACE}},$(RootNamespace);
			{{DESCRIPTION}},$(AppTitle);
			{{AUTHORS}},$(SolutionAuthors);
			{{THEMECOLOR}},$(WebAppThemeColor);
			{{BACKGROUNDCOLOR}},$(WebAppBackgroundColor);
			{{INDEXTHEMESSECTION}},$(IndexThemesSection);
			{{INDEXBOOTSCRIPTSSECTION}},$(IndexBootScriptsSection);
			{{INDEXDEFAULTSCRIPTSSECTION}},$(IndexDefaultScriptsSection);
			{{APIHOSTNAME}},$(ApiHostProjectName.Trim());
			{{APIHOSTPATH}},$(ApiHostPathNormalized);
			{{WEBHOSTNAME}},$(WebHostProjectName.Trim());
			{{WEBHOSTPATH}},$(WebHostPathNormalized);
			{{ASPIREHOSTPATH}},$(AspireHostPathNormalized);
			{{ASPIREHOSTDIR}},$(AspireHostDirNormalized);
			Olympus.Aspire.Host,$(RootNamespace);
			Olympus.Api.Host,$(RootNamespace);
			Olympus.Web.Host,$(RootNamespace);
		</TemplatesReplacements>
	</PropertyGroup>

	<!-- Workspace Templates Definitions -->
	<ItemGroup Label="WorkspaceTemplatesDefinitions" Condition="$(IsMainSolution)=='false' And $(IsApplicationHost)=='true'">
		<WorkspaceTemplates Include="$(MSBuildThisFileDirectory)..\templates\Workspace\**\*.template">
			<GeneratedFile>$(SolutionFolder)\%(RecursiveDir)%(Filename)</GeneratedFile>
		</WorkspaceTemplates>
	</ItemGroup>

	<!-- Aspire Application Host Templates Definitions -->
	<ItemGroup Label="AspireHostTemplatesDefinitions" Condition="$(IsAspireApplicationHost)=='true'">
		<AspireHostCodeTemplates Include="$(MSBuildThisFileDirectory)..\templates\Aspire.Host\*.cs.template">
			<GeneratedFile>$(IntermediateOutputPath)$(RootNamespace).%(Filename).g.cs</GeneratedFile>
		</AspireHostCodeTemplates>
		<AspireHostPublishTemplates Include="$(MSBuildThisFileDirectory)..\templates\Aspire.Host\$Publish\**\*.template">
			<GeneratedFile>$(ProjectFolder)\$Publish\%(Filename)</GeneratedFile>
		</AspireHostPublishTemplates>
	</ItemGroup>

	<!-- Api Application Host Templates Definitions -->
	<ItemGroup Label="ApiHostTemplatesDefinitions" Condition="$(IsApiApplicationHost)=='true'">
		<ApiHostCodeTemplates Include="$(MSBuildThisFileDirectory)..\templates\Api.Host\*.cs.template">
			<GeneratedFile>$(IntermediateOutputPath)$(RootNamespace).%(Filename).g.cs</GeneratedFile>
		</ApiHostCodeTemplates>
	</ItemGroup>

	<!-- Web Application Host Templates Definitions -->
	<ItemGroup Label="WebHostTemplatesDefinitions" Condition="$(IsWebApplicationHost)=='true'">
		<WebHostCodeTemplates Include="$(MSBuildThisFileDirectory)..\templates\Web.Host\*.cs.template">
			<GeneratedFile>$(IntermediateOutputPath)$(RootNamespace).%(Filename).g.cs</GeneratedFile>
		</WebHostCodeTemplates>
		<WebHostAssetsTemplates Include="$(MSBuildThisFileDirectory)..\templates\Web.Host\wwwroot\**\*.template">
			<GeneratedFile>$(IntermediateOutputPath)wwwroot\%(RecursiveDir)%(Filename)</GeneratedFile>
			<RelativePath>%(RecursiveDir)%(Filename)</RelativePath>
		</WebHostAssetsTemplates>
	</ItemGroup>

	<!-- Process Workspace Templates -->
	<Target Name="ProcessWorkspaceTemplates" BeforeTargets="BeforeBuild;ResolveProjectReferences" Inputs="@(WorkspaceTemplates)" Outputs="%(WorkspaceTemplates.GeneratedFile)" Condition="$(IsApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ProcessTemplate
			InputFile="%(WorkspaceTemplates.Identity)"
			OutputFile="%(WorkspaceTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Generate Aspire Application Host Code Files -->
	<Target Name="GenerateAspireHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" Inputs="@(AspireHostCodeTemplates)" Outputs="%(AspireHostCodeTemplates.GeneratedFile)" Condition="$(IsAspireApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ProcessTemplate
			InputFile="%(AspireHostCodeTemplates.Identity)"
			OutputFile="%(AspireHostCodeTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Register Aspire Application Host Code Files -->
	<Target Name="RegisterAspireHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" DependsOnTargets="GenerateAspireHostCodeFiles" Condition="$(IsAspireApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ItemGroup>
			<Compile Include="@(AspireHostCodeTemplates->'%(GeneratedFile)')" />
			<FileWrites Include="@(AspireHostCodeTemplates->'%(GeneratedFile)')" />
		</ItemGroup>

	</Target>

	<!-- Generate Aspire Application Host Publish Files -->
	<Target Name="GenerateAspireHostPublishFiles" BeforeTargets="BeforeBuild;ResolveProjectReferences" Inputs="@(AspireHostPublishTemplates)" Outputs="%(AspireHostPublishTemplates.GeneratedFile)" Condition="$(IsAspireApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ProcessTemplate
			InputFile="%(AspireHostPublishTemplates.Identity)"
			OutputFile="%(AspireHostPublishTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Register Aspire Application Host Publish Files -->
	<Target Name="RegisterAspireHostPublishFiles" BeforeTargets="BeforeBuild;ResolveProjectReferences" DependsOnTargets="GenerateAspireHostPublishFiles" Condition="$(IsAspireApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ItemGroup>
			<Content Remove="@(AspireHostPublishTemplates->'%(GeneratedFile)')" />
			<Content Include="@(AspireHostPublishTemplates->'%(GeneratedFile)')">
				<Link>$Publish\%(AspireHostPublishTemplates.Filename)</Link>
				<CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
				<CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
			</Content>
			<FileWrites Include="@(AspireHostPublishTemplates->'%(GeneratedFile)')" />
		</ItemGroup>

	</Target>

	<!-- Generate Api Application Host Code Files -->
	<Target Name="GenerateApiHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" Inputs="@(ApiHostCodeTemplates)" Outputs="%(ApiHostCodeTemplates.GeneratedFile)" Condition="$(IsApiApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ProcessTemplate
			InputFile="%(ApiHostCodeTemplates.Identity)"
			OutputFile="%(ApiHostCodeTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Register Api Application Host Code Files -->
	<Target Name="RegisterApiHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" DependsOnTargets="GenerateApiHostCodeFiles" Condition="$(IsApiApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ItemGroup>
			<Compile Include="@(ApiHostCodeTemplates->'%(GeneratedFile)')" />
			<FileWrites Include="@(ApiHostCodeTemplates->'%(GeneratedFile)')" />
		</ItemGroup>

	</Target>

	<!-- Generate Web Application Host Code Files -->
	<Target Name="GenerateWebHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" Inputs="@(WebHostCodeTemplates)" Outputs="%(WebHostCodeTemplates.GeneratedFile)" Condition="$(IsWebApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ProcessTemplate
			InputFile="%(WebHostCodeTemplates.Identity)"
			OutputFile="%(WebHostCodeTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Register Web Application Host Code Files -->
	<Target Name="RegisterWebHostCodeFiles" BeforeTargets="BeforeCompile;CoreCompile" DependsOnTargets="GenerateWebHostCodeFiles" Condition="$(IsWebApplicationHost)=='true' And $(IsMainSolution)=='false'">

		<ItemGroup>
			<Compile Include="@(WebHostCodeTemplates->'%(GeneratedFile)')" />
			<FileWrites Include="@(WebHostCodeTemplates->'%(GeneratedFile)')" />
		</ItemGroup>

	</Target>

	<!-- Generate Web Application Host Assets Files -->
	<Target Name="GenerateWebHostAssetsFiles" BeforeTargets="BeforeBuild;ResolveProjectReferences" Inputs="@(WebHostAssetsTemplates)" Outputs="%(WebHostAssetsTemplates.GeneratedFile)" Condition="$(IsWebApplicationHost)=='true'">

		<ProcessTemplate
			InputFile="%(WebHostAssetsTemplates.Identity)"
			OutputFile="%(WebHostAssetsTemplates.GeneratedFile)"
			Replacements="$(TemplatesReplacements)"
		/>

	</Target>

	<!-- Register Web Application Host Assets Files -->
	<Target Name="RegisterWebHostAssetsFiles" BeforeTargets="BeforeBuild;ResolveProjectReferences" DependsOnTargets="GenerateWebHostAssetsFiles" Condition="$(IsWebApplicationHost)=='true'">

		<ItemGroup>
			<GeneratedTemplates Include="@(WebHostAssetsTemplates->'%(GeneratedFile)')">
				<RelativePath>%(WebHostAssetsTemplates.RelativePath)</RelativePath>
			</GeneratedTemplates>
		</ItemGroup>

		<DefineStaticWebAssets
			CandidateAssets="@(GeneratedTemplates)"
			SourceType="Computed"
			SourceId="$(PackageId)"
			ContentRoot="$(IntermediateOutputPath)wwwroot\"
			BasePath="/"
			AssetKind="All"
			AssetMode="All"
			AssetRole="Primary"
			AssetMergeSource="$(StaticWebAssetMergeTarget)"
			CopyToOutputDirectory="Never"
			CopyToPublishDirectory="PreserveNewest"
		>
			<Output TaskParameter="Assets" ItemName="GeneratedTemplatesAssets" />
		</DefineStaticWebAssets>

		<DefineStaticWebAssetEndpoints
			CandidateAssets="@(GeneratedTemplatesAssets)"
			ExistingEndpoints="@(StaticWebAssetEndpoint)"
			ContentTypeMappings="@(StaticWebAssetContentTypeMapping)"
		>
			<Output TaskParameter="Endpoints" ItemName="GeneratedTemplatesEndpoints" />
		</DefineStaticWebAssetEndpoints>

		<ItemGroup>
			<StaticWebAsset Include="@(GeneratedTemplatesAssets)" />
			<StaticWebAssetEndpoint Include="@(GeneratedTemplatesEndpoints)" />
			<FileWrites Include="@(GeneratedTemplates)" />
		</ItemGroup>

	</Target>

</Project>